name: Daily Ingest (House)

on:
  workflow_dispatch:
  schedule:
    - cron: "15 13 * * *" # 05:15 Pacific

jobs:
  ingest:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP: congress-tracker

    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verify flyctl
        run: |
          which flyctl
          flyctl version

      - name: Pick Fly machine
        id: pick
        run: |
          set -euo pipefail
          MID="$(flyctl machines list -a "$APP" --json | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['id'])")"
          echo "Using machine: $MID"
          echo "MID=$MID" >> $GITHUB_ENV

      - name: Ingest House
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" 'sh -lc "cd /app && python -m app.ingest_house"'

      - name: Ingest Senate
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" 'sh -lc "cd /app && python -m app.ingest_senate"'

      - name: Enrich Members
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" 'sh -lc "cd /app && python -m app.enrich_members"'
