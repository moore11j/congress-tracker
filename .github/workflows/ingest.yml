name: Daily Ingest

on:
  workflow_dispatch:
  schedule:
    - cron: "15 13 * * *" # 05:15 Pacific

jobs:
  ingest:
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      APP: congress-tracker-api
      MID: 8e7ed9a77d0098   # <-- pinned machine ID

    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verify flyctl
        run: |
          flyctl version

      - name: Ensure machine is running
        run: |
          set -euo pipefail
          flyctl machine start "$MID" -a "$APP" || true

      - name: Ingest House
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" \
            'sh -lc "cd /app && python3 -m app.ingest_house"'

      - name: Ingest Senate
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" \
            'sh -lc "cd /app && python3 -m app.ingest_senate"'

      - name: Enrich Members
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" \
            'sh -lc "cd /app && python3 -m app.enrich_members"'

      - name: Write Last Updated
        run: |
          set -euo pipefail
          flyctl machine exec "$MID" -a "$APP" \
            'sh -lc "cd /app && python3 -m app.write_last_updated"'
